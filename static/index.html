<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>title</title>

  </head>
  <body>

 <canvas id="myCanvas" width="300" height="200" style="width:600px;height:auto;background-color:ghostwhite"></canvas> 
 <br>

  <div style="background-color:ghostwhite;display:inline-block">
    <input type="file" id="imageinput"><br>
   
    <input type="button" role="button" value="submit" onclick="handleFiles()"><br>
    
</div>
 <div style="background-color:ghostwhite;display:inline-block">
 <input class="tagname" type="text" placeholder="kitten"><br>
 <input class="tagname" type="text" placeholder="corvette"><br>
 <input class="tagname" type="text" placeholder="mountain"><br>
</div>
<br>
<div id="status">Select an image and enter up to 3 tile tags</div>

  <script>

  var curwidth = 600;

  document.getElementById("myCanvas").addEventListener("mousedown",function(e){

    if (e.button!==0){
      return;
    }

    if (!e.ctrlKey){
      curwidth+=200;
    }else if(curwidth>200){
      curwidth-=200;
    }

    document.getElementById('myCanvas').style.width = curwidth + 'px';

  });



  function setStatus(text){
    document.getElementById("status").innerHTML=text;
  }

  function loadCanvas(image, width, height) {
    var canvas = document.getElementById('myCanvas');
    canvas.width=width;
    canvas.height=height;
    var context = canvas.getContext('2d');

    // load image
    context.drawImage(image, 0, 0); 
}


  function listen(key){

    var evtSource = new EventSource("listen?key="+key);

    evtSource.onerror=function(e){
      evtSource.close();
      //console.log(e);
    }
   
    evtSource.addEventListener("progress", function(e) {
     
      setStatus(e.data);
     
    }, false);


    evtSource.addEventListener("image", function(e) {
     
      var result = JSON.parse(e.data)
      var height = result.height;
      var width=result.width;
      var base64 = result.base64;

      var img = new Image();   
      img.src = 'data:image/png;base64,'+base64;

      loadCanvas(img, width, height);

    }, false);

  }




    function handleFiles() {

      var t = document.getElementsByClassName("tagname");

      var tags = [].slice.call(t).map(function(tag){
        return tag.value;
      }).filter(function(val){
        return val.length>0;
      });

      console.log(tags);

      if (tags.length==0) {
        setStatus("please enter at least one tag");
        return;
      }

      var terms = tags.reduce(function(cur,next,indx){
        if (indx){
          cur+="&";
        }
        return cur+"terms=" + next;
      },"?");

      var el = document.getElementById("imageinput");
      var files = el.files;

      reader = new FileReader();

      reader.onload = function (e) {

        var buffer = e.target.result;

        console.log(e);

        var dv = new Int8Array(buffer, 0);

        var xhr = new XMLHttpRequest;
        xhr.open("POST", "/postimage"+terms, true);

        xhr.onload = function () {

          //console.log(this.response);
          listen(this.response) 

        };

        xhr.send(dv);

      };

      console.log(files[0]);

      reader.readAsArrayBuffer(files[0]);


    }


  </script>
  </body>
</html>